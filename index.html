<!DOCTYPE html>
<html>
<head>
    <title>Google Docs</title>
    <style>
        :root { 
            --bg: #020617; 
            --card: #0f172a; 
            --accent: #3b82f6; 
            --text: #f8fafc; 
        }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg); color: var(--text); font-family: sans-serif;
            background-size: cover; background-position: center; background-attachment: fixed;
        }
        .navbar { background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; z-index: 1000; }
        .container { padding: 30px; max-width: 1400px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .game-card { background: var(--card); border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; border: 1px solid transparent; transition: 0.3s; position: relative; }
        .game-card:hover { border-color: var(--accent); transform: translateY(-3px); }
        .fav-star { position: absolute; top: 8px; right: 8px; cursor: pointer; color: rgba(255,255,255,0.2); }
        .fav-star.active { color: #fbbf24; }
        #gameFrame { width: 100%; height: calc(100vh - 70px); border: none; display: none; }
        .modal { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-ui { padding: 10px 20px; background: var(--accent); border: none; color: white; border-radius: 8px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="authModal" class="modal">
        <h1 id="title">MONGLE</h1>
        <div id="loginBox">
            <input type="text" id="userInput" placeholder="Username..." style="padding:12px; border-radius:8px; border:1px solid #333; background:#111; color:#fff;">
            <button class="btn-ui" onclick="checkUser()">Sign In</button>
        </div>
        <div id="passBox" style="display:none;">
            <input type="password" id="passInput" placeholder="Password...">
            <button class="btn-ui" onclick="verify()">Verify</button>
        </div>
    </div>

    <div id="nav" class="navbar">
        <div id="clock">00:00:00</div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="search" placeholder="Search..." onkeyup="filter()" style="background:#000; color:#fff; border:1px solid #333; padding:5px; border-radius:5px;">
            <button class="btn-ui" onclick="closeGame()" id="backBtn" style="display:none; background:#334155;">Back</button>
            <button class="btn-ui" onclick="cloak()">About:Blank</button>
            <button class="btn-ui" style="background:#ef4444" onclick="location.replace('https://classroom.google.com')">Panic</button>
        </div>
    </div>

    <div id="arcade" class="container">
        <div id="favBox" style="display:none;"><h2 style="color:#fbbf24">Favorites</h2><div id="favGrid" class="grid"></div><hr style="opacity:0.1; margin:40px 0;"></div>
        <div id="mainGrid" class="grid"></div>
    </div>

    <iframe id="gameFrame"></iframe>

    <script>
        const CONFIG = {
            user: "bob154526-hue",
            repo: "Mongle",
            pass: "1234"
        };

        let isPlaying = false;

        // --- THEME & REFRESH LOGIC ---
        function applySettings() {
            const bg = localStorage.getItem('globalBG') || '#020617';
            const emoji = localStorage.getItem('globalEmoji') || 'ðŸŽ®';
            const accent = localStorage.getItem('globalAccent') || '#3b82f6';
            
            document.documentElement.style.setProperty('--bg', bg);
            document.documentElement.style.setProperty('--accent', accent);
            if(bg.includes('http')) document.body.style.backgroundImage = `url(${bg})`;
            else document.body.style.backgroundColor = bg;
        }

        // Listen for changes from Admin Panel
        window.addEventListener('storage', (e) => {
            if (['globalBG', 'globalEmoji', 'globalAccent'].includes(e.key)) {
                if (!isPlaying) {
                    location.reload();
                } else {
                    console.log("Update pending: Waiting for game to finish...");
                }
            }
        });

        // --- AUTH ---
        if(sessionStorage.getItem('auth')) document.getElementById('authModal').style.display = 'none';
        function checkUser() {
            let n = document.getElementById('userInput').value.toLowerCase();
            if(n === 'mongle') { document.getElementById('loginBox').style.display='none'; document.getElementById('passBox').style.display='block'; }
            else if(n) { sessionStorage.setItem('auth', n); location.reload(); }
        }
        function verify() {
            if(document.getElementById('passInput').value === CONFIG.pass) { sessionStorage.setItem('auth', 'mongle'); location.reload(); }
        }

        // --- GAME LOADING (BLOB FIX) ---
        async function launch(url) {
            isPlaying = true;
            document.getElementById('arcade').style.display = 'none';
            document.getElementById('backBtn').style.display = 'block';
            const frame = document.getElementById('gameFrame');
            frame.style.display = 'block';

            try {
                const res = await fetch(url);
                const html = await res.text();
                // Blobs need the correct MIME type to execute scripts
                const blob = new Blob([html], { type: 'text/html' });
                frame.src = URL.createObjectURL(blob);
            } catch(e) { frame.src = url; } // Fallback to direct URL
        }

        function closeGame() {
            isPlaying = false;
            document.getElementById('gameFrame').style.display = 'none';
            document.getElementById('gameFrame').src = "";
            document.getElementById('arcade').style.display = 'block';
            document.getElementById('backBtn').style.display = 'none';
            // Check if we need to reload now that game is over
            applySettings(); 
        }

        async function load() {
            const res = await fetch(`https://api.github.com/repos/${CONFIG.user}/${CONFIG.repo}/contents/`);
            const files = await res.json();
            const main = document.getElementById('mainGrid');
            const favGrid = document.getElementById('favGrid');
            const favs = JSON.parse(localStorage.getItem('mFavs')) || [];
            
            main.innerHTML = ""; favGrid.innerHTML = "";
            let hasFavs = false;

            files.filter(f => f.name.endsWith('.html') && f.name !== 'index.html').forEach(file => {
                const isFav = favs.includes(file.name);
                const card = document.createElement('div');
                card.className = 'game-card';
                card.innerHTML = `
                    <span class="fav-star ${isFav?'active':''}" onclick="toggleFav(event,'${file.name}')">â˜…</span>
                    <div onclick="launch('${file.download_url}')">
                        <div style="font-size:40px">${localStorage.getItem('globalEmoji') || 'ðŸŽ®'}</div>
                        <b>${file.name.replace('.html','')}</b>
                    </div>
                `;
                main.appendChild(card);
                if(isFav) { hasFavs = true; favGrid.appendChild(card.cloneNode(true)); favGrid.lastChild.onclick = () => launch(file.download_url); }
            });
            document.getElementById('favBox').style.display = hasFavs ? 'block' : 'none';
        }

        function toggleFav(e, f) {
            e.stopPropagation();
            let favs = JSON.parse(localStorage.getItem('mFavs')) || [];
            favs = favs.includes(f) ? favs.filter(x => x !== f) : [...favs, f];
            localStorage.setItem('mFavs', JSON.stringify(favs));
            load();
        }

        function cloak() {
            const win = window.open('about:blank', '_blank');
            const doc = win.document;
            const iframe = doc.createElement('iframe');
            iframe.style = "position:fixed; top:0; left:0; width:100%; height:100%; border:none;";
            iframe.src = location.href;
            doc.body.appendChild(iframe);
            window.location.replace('https://google.com');
        }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        applySettings();
        load();
    </script>
</body>
</html>
